olark.declare({name:"CobrowseBeta",version:"1.0",startup:function(h,d){function e(a){var c=this;a=a||{};this._api=a.legacyOlarkAPI;this._win=a.window||window;this._doc=this._win.document;this._accountToken=a.accountToken;this._apiToken=a.apiToken;this._libraryURL=a.libraryURL;this._silent=a.silent;this._calls=[];this._connectionTimer=this._checkFireflyTimer=null;this._connecting=!1;this._active=this._api.data.getConversationObject({key:"active"});this._active.get()&&this._ensureFireflyIsAvailable();
this._lastURL=this._api.data.getConversationObject({key:"lastURL"});this._operatorName=null;this._api.chat.onMessageToVisitor(function(b){c._operatorName=b.message.nickname});this.on("cobrowsingEnded",function(){c._notify("visitor has ended cobrowsing");c._clearConnection()});this.on("repControlRequested",function(){if(c._silent)c.grantRepControl(!0);else{var b=confirm("Would you like "+(c._operatorName||"the operator")+" to take control?");c.grantRepControl(b)}});this.set("theme","black");this.set("whitelabel",
!0);this._api.chat.__SPI_onInterfaceElementReady(function(b){c._populateInterface(b.key,b.dom)})}var f=["on","set","startAPI","grantRepControl"];(function(a){for(var c in f)(function(b){a[b]=function(){this._calls.push({method:b,args:arguments});this._dequeueCalls()}})(f[c]);a.sendBetaNotification=function(){this._notify("Thank you for participating in our cobrowsing beta program! Your feedback helped prepare us to release cobrowsing to all Olark customers over the next week or so.\n\nWe wanted to give you an early heads-up about some changes that you need to be aware of. The most important change is that we will now ask the visitor before sharing their browser. You may want to read our help article for more info: https://www.olark.com/help/cobrowsing\n\nYour account will be migrated to the new cobrowsing within about a week, but you can switch early if you want by visiting this page: https://olark.com/extensions/cobrowse/join")};
a.ensureSharing=function(){var b=this;this._ensureFireflyIsAvailable();if(this._lastURL.get())this._notify("see what they see ==> "+this._lastURL.get());else if(this._connecting)this._notify("waiting for visitor to accept screen sharing...");else{this._notify("connecting with the visitor's browser...");this._startConnection();try{this.startAPI(this._apiToken,{suppressUI:!0},function(a){b._clearConnection();b._active.set(!0);if(a){var c=a.replace(/.*olark\.usefirefly\.com\//,"https://static.olark.com/view/#");
b._notify("see what they see ==> "+c);b._lastURL.set(a)}else b._notify("the visitor declined to share their screen")})}catch(a){window.console&&window.console.warn&&window.console.warn("[olark] unable to start cobrowsing session: "+a),this._notify("unable to start cobrowsing session, please contact us if this happens often: beta+cobrowsing@olark.com")}}};a._notify=function(b){this._api.chat.sendNotificationToOperator({body:b})};a._createInterface=function(b){this._api.chat.__SPI_sendInterfaceElementToVisitor({key:b})};
a._populateInterface=function(b,a){if(b==="confirmation-box")a.innerHTML="Do you want to allow the operator to view your screen? <a href='#'>yes</a>",a.style.border="1px solid red"};a._ensureFireflyIsAvailable=function(){if(!this._firefly()){window.fireflyAPI={token:this._accountToken};var b=this._doc.createElement("script");b.type="text/javascript";b.src=this._libraryURL;b.async=!0;var a=this._doc.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)}};a._firefly=function(){return window.fireflyAPI};
a._ready=function(){var b=this._firefly();return b&&b.startAPI?!0:!1};a._dequeueCalls=function(){if(this._ready())for(var b=this._firefly();this._calls.length;){var a=this._calls.shift();b[a.method].apply(b,a.args)}else if(!this._checkFireflyTimer){var c=this;this._checkFireflyTimer=setTimeout(function(){c._checkFireflyTimer=null;c._dequeueCalls()},1E3)}};a._startConnection=function(){var a=this;this._connecting=!0;this._connectionTimer=setTimeout(function(){a._connecting&&(a._notify("looks like connecting with the browser is going slowly, please contact us if this happens often: beta+cobrowsing@olark.com"),
a._clearConnection())},11E3)};a._clearConnection=function(){this._connecting=!1;clearTimeout(this._connectionTimer);this._connectionTimer=null;this._lastURL.set(null);this._active.set(!1)}})(e.prototype);var i=new window.olark.__core.BrowserTab({idStorageKey:"olark.activeBrowserTab"}),g=new e({legacyOlarkAPI:h,accountToken:d.system.firefly_account_token||"507dd5f985dbad354701c5b6",apiToken:d.system.firefly_api_token||"507dd5f988a1113547000001",libraryURL:d.system.firefly_library_url||"https://firefly-071591.s3.amazonaws.com/scripts/loaders/loader.js",
silent:!d.system.prompt_visitor_for_cobrowsing});olark("api.chat.onCommandFromOperator",function(a){a.command.name==="see"&&i.active()&&(olark._.hlog("#cobrowsing_beta_session"),g.sendBetaNotification(),g.ensureSharing())})}});
